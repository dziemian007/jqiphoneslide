/**
 * iphoneSlide - jQuery plugin
 * @version: 0.32 (2010/04/07)
 * @requires jQuery v1.3.2 or later 
 * @author Hina, Cain Chen. hinablue [at] gmail [dot] com
 * Examples and documentation at: http://jquery.hinablue.me/jqiphoneslide
 
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
**/
(function($){var r={handler:undefined,pageHandler:undefined,slideHandler:undefined,nextPageHandler:'.nextPage',prevPageHandler:'.prevPage',friction:0.325,sensitivity:20,extrashift:800,touchduring:800,direction:'horizontal',maxShiftPage:5,easing:"swing",pageshowfilter:false,onShiftComplete:function(){}};$.fn.iphoneSlide=function(o,p){var q=$.extend({},r,o),p=p;function __getMovingData(w,s,e,t){var v=0,s=0;v=(Math.abs(s-e)/Math.abs(t)).toPrecision(5);s=Math.floor(Math.pow(v,2)*Math.abs(q.extrashift)/(2*0.0098*Math.abs(q.friction)));s=(s>w/2)?Math.floor(w/3):s;return{"speed":v,"shift":s}}function __initPages(w){var a,workspace=w,handler=$(q.handler,workspace),pagesHandler=(!q.pageshowfilter)?handler.children(q.pageHandler):handler.children(q.pageHandler).filter(':visible'),matrixSqrt=0,matrixColumn=0;a=pagesHandler.length;switch(q.direction){case"matrix":matrixSqrt=Math.ceil(Math.sqrt(a));matrixColumn=Math.ceil(a/matrixSqrt);if(matrixColumn*matrixSqrt>a){var b=pagesHandler.filter(":first"),lastChild=pagesHandler.filter(":last");for(var i=0;i<(matrixColumn*matrixSqrt-a);i++){b.clone().empty().removeAttr('id').removeAttr('style').addClass("matrix-blank-page").css('display','block').insertAfter(lastChild)}a=matrixColumn*matrixSqrt}for(var i=matrixColumn;i>1;i--){$('<br class="matrix-break-point" style="clear:both;" />').insertAfter(pagesHandler.eq((i-1)*matrixSqrt-1))}handler.width(matrixSqrt*workspace.width()).height(matrixColumn*workspace.height());break;case"vertical":handler.height(a*workspace.height());break;case"horizontal":default:handler.width(a*workspace.width())}pagesHandler.css({'display':'block'});workspace.data("totalPages",a).data("matrixSqrt",matrixSqrt).data("matrixColumn",matrixColumn).data("nowPage",1).data("initIphoneSlide",true);if($.isFunction(p))p.call(workspace)}function __onSlideCallback(w){var a=w,nowPage=a.data("nowPage");if(q.pageshowfilter){q.onShiftComplete.call(a,$(q.handler,a).children(q.pageHandler).filter(':visible').eq(nowPage-1),nowPage)}else{q.onShiftComplete.call(a,$(q.handler,a).children(q.pageHandler).eq(nowPage-1),nowPage)}return false}function __slidingPage(h,d,m){var a=h.parent(),handler=h,direction=d,matrix=m,matrixSqrt=a.data("matrixSqrt"),left=((direction)?"-=":"+="),top=((direction)?"-=":"+="),_width=a.width(),_height=a.height();switch(q.direction){case"matrix":if(matrix){left=(direction)?"+=":"-=";handler.animate({'left':left+((matrixSqrt-1)*_width)+"px",'top':top+_height+"px"},function(){__onSlideCallback(a)})}else{handler.animate({'left':left+_width+"px"},function(){__onSlideCallback(a)})}break;case"vertical":handler.animate({'top':top+_height+"px"},function(){__onSlideCallback(a)});break;case"horizontal":default:handler.animate({'left':left+_width+"px"},function(){__onSlideCallback(a)})}}return this.each(function(){var g=$(this),handler=$(q.handler,g),totalPages=0,nowPage=1,matrixSqrt=0,matrixColumn=0;if(g.children().length>1){alert('The Selector('+g.attr('id')+')\'s page handler can not more than one element.');return this}if(q.handler==undefined||typeof q.handler!=="string"){q.handler=".iphone-slide-page-handler";g.children(':first').addClass('iphone-slide-page-handler')}if($(q.handler,g).children().length==0){alert('You have no page(s) context.');return this}if(q.pageHandler==undefined||typeof q.pageHandler!=="string"){switch(handler.attr('tagName').toLowerCase()){case"ul":case"ol":q.pageHandler='li';break;default:q.pageHandler=handler.children(':first').attr('tagName').toLowerCase()}}var h=function(a){var b=g.data("nowPage"),totalPages=g.data("totalPages"),matrixSqrt=g.data("matrixSqrt");b++;if(b<=totalPages){if(q.direction=="matrix"&&((b-1)%matrixSqrt==0)){__slidingPage(handler,true,true)}else{__slidingPage(handler,true,false)}}else{b=totalPages}g.data("nowPage",b);return false};var i=function(a){var b=g.data("nowPage"),totalPages=g.data("totalPages"),matrixSqrt=g.data("matrixSqrt");b--;if(b>0){if(q.direction=="matrix"&&(b%matrixSqrt==0)){__slidingPage(handler,false,true)}else{__slidingPage(handler,false,false)}}else{b=1}g.data("nowPage",b);return false};var j=false,__mouseStarted=false,__mouseTarget,__mouseDownEvent;var k=function(a){if(__mouseStarted)return false;a.originalEvent=a.originalEvent||{};if(a.originalEvent.mouseHandled){return}(__mouseStarted&&m(a));__mouseDownEvent=a;__mouseTarget=$(a.target);a.preventDefault();g.bind('mousemove',l).bind('mouseleave mouseup',m);a.originalEvent.mouseHandled=true};var l=function(a){if($.browser.msie&&!a.button)return m(a);if(__mouseStarted)return a.preventDefault();return!__mouseStarted};var m=function(a){var b=g.data("totalPages"),nowPage=g.data("nowPage"),matrixSqrt=g.data("matrixSqrt"),matrixColumn=g.data("matrixColumn");g.unbind('mousemove',l).unbind('mouseleave mouseup',m);if(__mouseStarted)j=(a.target==__mouseDownEvent.target);if(n(a)){var c,_width=g.width(),_height=g.height(),timeStamp=Math.abs(__mouseDownEvent.timeStamp-a.timeStamp);var d={"X":__getMovingData(_width,__mouseDownEvent.pageX,a.pageX,timeStamp),"Y":__getMovingData(_height,__mouseDownEvent.pageY,a.pageY,timeStamp),},pages={"X":(timeStamp>q.touchduring)?1:Math.ceil(d.X.speed*d.X.shift/_width),"Y":(timeStamp>q.touchduring)?1:Math.ceil(d.Y.speed*d.Y.shift/_height)},easing={"X":Math.min(a.pageX-__mouseDownEvent.pageX,q.maxShiftPage),"Y":Math.min(a.pageY-__mouseDownEvent.pageY,q.maxShiftPage)},shift={"X":"","Y":"","EX":"","EY":"","shift":Math.max(d.X.shift,d.Y.shift),"speed":Math.max(d.X.speed,d.Y.speed)};c=Math.max(1/shift.speed*Math.abs(q.extrashift),Math.abs(q.extrashift)*0.5);switch(q.direction){case"matrix":var e=Math.ceil(nowPage/matrixSqrt);pages.X=(pages.X>matrixSqrt)?matrixSqrt:(Math.floor(Math.abs(easing.Y/easing.X))>2)?0:pages.X;pages.Y=(pages.Y>matrixColumn)?matrixColumn:(Math.floor(Math.abs(easing.X/easing.Y))>2)?0:pages.Y;if(easing.X>0){pages.X=Math.min(pages.X,(nowPage-matrixSqrt*(e-1)-1));nowPage=((nowPage-pages.X)<1)?1:nowPage-pages.X;shift.X="+=";shift.EX="-="}else{pages.X=Math.min(pages.X,(matrixSqrt*e-nowPage));nowPage=(nowPage+pages.X>b)?b:nowPage+pages.X;shift.X="-=";shift.EX="+="}shift.X+=((pages.X*_width+shift.shift).toString())+"px";shift.EX+=(shift.shift.toString())+"px";if(easing.Y>0){pages.Y=Math.min(pages.Y,(e-1));nowPage=((nowPage-pages.Y*matrixSqrt)<1)?1:nowPage-pages.Y*matrixSqrt;shift.Y="+=";shift.EY="-="}else{pages.Y=((matrixSqrt*pages.Y+nowPage)>b)?(matrixColumn-e):pages.Y;nowPage=(pages.Y*matrixSqrt>b)?b:nowPage+pages.Y*matrixSqrt;shift.Y="-=";shift.EY="+="}shift.Y+=((pages.Y*_height+shift.shift).toString())+"px";shift.EY+=(shift.shift.toString())+"px";break;case"vertical":pages.X=0;pages.Y=(pages.Y==0)?1:((pages.Y>q.maxShiftPage)?q.maxShiftPage:pages.Y);if(easing.Y>0){pages.Y=((nowPage-pages.Y)<1)?nowPage-1:pages.Y;nowPage=((nowPage-pages.Y)<1)?1:nowPage-pages.Y;shift.Y="+=";shift.EY="-="}else{pages.Y=((nowPage+pages.Y)>b)?b-nowPage:pages.Y;nowPage=((nowPage+pages.Y)>b)?b:nowPage+pages.Y;shift.Y="-=";shift.EY="+="}shift.X="+=0px";shift.Y+=((pages.Y*_height+shift.shift).toString())+"px";shift.EY+=(shift.shift.toString())+"px";shift.EX="+=0px";break;case"horizontal":default:pages.Y=0;pages.X=(pages.X==0)?1:((pages.X>q.maxShiftPage)?q.maxShiftPage:pages.X);if(easing.X>0){pages.X=((nowPage-pages.X)<1)?nowPage-1:pages.X;nowPage=((nowPage-pages.X)<1)?1:nowPage-pages.X;shift.X="+=";shift.EX="-="}else{pages.X=((nowPage+pages.X)>b)?b-nowPage:pages.X;nowPage=((nowPage+pages.X)>b)?b:nowPage+pages.X;shift.X="-=";shift.EX="+="}shift.X+=((pages.X*_width+shift.shift).toString())+"px";shift.Y="+=0px";shift.EX+=(shift.shift.toString())+"px";shift.EY="+=0px"}var f=($.easing[q.easing]!==undefined)?q.easing:"swing";handler.animate({'top':shift.Y,'left':shift.X},c).animate({'top':shift.EY,'left':shift.EX},{duration:c,easing:f,complete:function(){__mouseStarted=false;__onSlideCallback(g)}})}g.data("nowPage",nowPage);return false};var n=function(a){return(Math.max(Math.abs(__mouseDownEvent.pageX-a.pageX),Math.abs(__mouseDownEvent.pageY-a.pageY))>=parseInt(q.sensitivity))};if(q.slideHandler==undefined||typeof q.slideHandler!=="string"){g.bind("mousedown",k).bind("click",function(a){if(j){j=false;a.stopImmediatePropagation();return false}})}else{handler.filter(q.slideHandler).bind("mousedown",k).bind("click",function(a){if(j){j=false;a.stopImmediatePropagation();return false}})}handler.filter(q.nextPageHandler).bind("click",h);handler.filter(q.nextPageHandler).bind("click",i);__initPages(g);return this})}})(jQuery);